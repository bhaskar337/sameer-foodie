<!DOCTYPE html>
<html>
<head>
  <title>Slide Menu</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>


<style>

  .glyphicon-chevron-down{
    color:white;
  }

  #right-panel-button{
    cursor: pointer;
    float:right;
    margin-top:8px;
    margin-right:10px;
    color:white;
    background-color:inherit;
    display:none;
    border:0;
  }


  .right-panel{
    position: absolute;
    background:white;
    border-left:1px solid silver;
    right:0px;
    width:250px;
    height:100%;
    z-index: 1;
    overflow-y: hidden;
    transition:0.5s;
  }

  .right-panel-header{
    font-weight: bold;
    text-align: center;
    border-bottom: 1px solid silver;
    width: 100%;
    height: 30px;
  }

  .expert{
    height: 50px;    }

  .expert:hover{
    cursor: pointer;
    background-color: rgba(255, 0, 0, 0.2);
    background-image: linear-gradient(#de696b,#de696b);
    background-repeat: no-repeat;
    background-size: 4px 100%, calc(100% - 4px) 50%;
  }

  .expert img{
    vertical-align:middle;
    margin-top: 6px;
    margin-left:10px;
    width:40px;
    height:40px;
    border-radius: 18px;
  }

  #main-content-wrapper{
    position: absolute;
    width:50%;
    margin-left:300px;
    border:1px solid #414141;
  }

  @media screen and (max-width:1200px){

    #right-panel-button{
      display:inline;
    }

    .right-panel{
      width:0px;
    }
  }

  /*for chat popups*/
  .popup-box
  {
    display: none;
    position: fixed;
    bottom: 5px;
    right: 250px;
    height: 285px;
    background-color: rgb(237, 239, 244);
    width: 300px;
    border: 1px solid rgba(29, 49, 91, .3);
    z-index: 2;
    border-radius:5px;
  }

  .popup-box .popup-head
  {
    background-color: #414141;
    padding: 5px;
    color: white;
    font-weight: bold;
    font-size: 14px;
    clear: both;
    height:30px;
    border-top-left-radius:5px;
    border-top-right-radius: 5px;
  }

  .popup-box .popup-head .popup-head-left
  {
    float: left;
    cursor: pointer;
  }

  .popup-box .popup-head .popup-head-right
  {
    cursor: pointer;
    float: right;
    opacity: 0.5;
  }

  .popup-box .popup-head .popup-head-right a
  {
    text-decoration: none;
    color: inherit;
  }

  .popup-box .popup-body-form-wrapper{
    background-image:url('images/chat-background.jpg');
    background-size: cover;
    display:block;
    height:100%;
  }

  .popup-box .popup-messages
  {
    height:80%;
    overflow-y: scroll;
  }

  .message-input{
      width:80%;
      border:1px solid white;
      border-radius:2px;
      margin-left:5px;
      margin-bottom: 5px;
  }

  .send-button{
      border: 1px solid #deb696;
      border-radius:15px;
      background-color: #DE696B;
      height:30px;
      margin-left: 10px;
  }

  .glyphicon-send{
      color:white;
  }
  .s_message, .r_message{
    display: block;
    border-radius:10px;
    margin-bottom: 10px;
    padding: 2px 10px;
    text-align: center;
    white-space: nowrap;
    clear: both;
    -webkit-animation-duration: 0.1s;
    animation-duration: 0.1s;
    -webkit-animation-fill-mode: both;
    animation-fill-mode: both;
    -webkit-animation-name: fadeIn;
    animation-name: fadeIn;

  }
  .s_message{
    background-color: palegreen;
    float:right;
    margin-right: 15px;
    
  }
  .r_message{
    background-color: #f2f2f2;
    float:left;
    margin-left: 15px;
  }

  @-webkit-keyframes fadeIn {
    0% {opacity: 0;}
    100% {opacity: 1;}
  }

  @keyframes fadeIn {
    0% {opacity: 0;}
    100% {opacity: 1;}
  }
</style>

  <script>
    $(document).ready(function(){

      /*rotate clockwise*/
      function rotateClock(element){
        $(element).css('ms-transform','rotate(180deg)');
        $(element).css('-webkit-transform','rotate(180deg)');
        $(element).css('transform','rotate(180deg)');
        $(element).css('transition','0.5s');
      }

      /*rotate anticlockwise*/
      function rotateAntiClock(element){
        $(element).css('ms-transform','rotate(0deg)');
        $(element).css('-webkit-transform','rotate(0deg)');
        $(element).css('transform','rotate(0deg)');
        $(element).css('transition','0.5s');
      }

      var down=1;

      $('.navbar-toggle').click(function(){
        if(down==1){
          rotateClock(this);
          down=0;
        }

        else{
          rotateAntiClock(this);
          down=1;
        }
      });


      /*Show and Hide Right Side Panel and rotate glyph*/
      $('#right-panel-button').click(function(e){
        manageRightPanel(e,this);

      });

      var rightStatus=false;
      function manageRightPanel(e,element){
        e.preventDefault();
        width = $(window).width();
        if(rightStatus==false){
          rotateClock(element);
          $('.right-panel').css('width','250px');
        }

        else{
          rotateAntiClock(element);
          $('.right-panel').css('width','0px');
        }
        rightStatus=!rightStatus;
      }

      var oldWidth = $(window).width();
      function handleOnResize(){
        calculate_popups();
        currentWidth = $(window).width();
        if(oldWidth < currentWidth && currentWidth >= 992){
          $('.right-panel').css('width','250px');

          if(rightStatus == 1){
            rotateAntiClock($('#right-panel-button'));
            rightStatus = 0;
          }
        }   

        if(oldWidth > currentWidth && currentWidth < 992){
          $('.right-panel').css('width','0px');
        }
        oldWidth = currentWidth;
      }
      window.addEventListener("resize",handleOnResize);

    /**************************
     for chat popups
     ***************************/


    //this variable represents the total number of popups can be displayed according to the viewport width
    var total_popups = 0;

    //arrays of popups ids
    var popups = [];

    //this is used to close a popup
    function close_popup(id)
    {
      for(var i in popups)
      {
        if(id == popups[i])
        {
          popups.splice(i,1);

          $('#'+id).hide();

          calculate_popups();

          return;
        }
      }
    }

    //displays the popups. Displays based on the maximum number of popups that can be displayed on the current viewport width
    function display_popups()
    {
      var right = ($(window).width()-(total_popups*320))/total_popups;
      var i;
      for(i=0; i < total_popups; i++)
      {
        if(popups[i])
        {
          $('#'+popups[i]).css("right",right+"px").show();
          right+=350;
        }
      }
      
       for(var j = i; j < popups.length; j++)
       {
          $('#'+popups[j]).hide();
       }
    }

    //creates markup for a new popup. Adds the id to popups array.
    function register_popup(id, name)
    {

      for(var i in popups)
      {
        //already registered. Bring it to front.
        if(id == popups[i])
        {
          popups.splice(i,1);

          popups.unshift(id);

          resizePopup($('#'+id),false);

          calculate_popups();

          return;
        }
      }

      var element = '<div class="popup-box chat-popup" id="'+id+'">';
      element = element + '<div class="popup-head">';
      element = element + '<div class="popup-head-left">'+ name +'</div>';
      element = element + '<div class="popup-head-right" data-target="'+id+'">&#10005</div>';
      element = element + '<div style="clear: both"></div></div><div class="popup-body-form-wrapper"><div class="popup-messages"></div>';
      element = element + '<form class="message"> <input type="text" class="message-input"></input><button type="submit" value="" class="send-button"><span class="glyphicon glyphicon-send"></span></button></form></div></div>';
  

      $('body').append(element)

      popups.unshift(id);

      calculate_popups();

    }

    //calculate the total number of popups suitable and then populate the total_popups variable.
    function calculate_popups()
    {
      var effectiveWidth = $(window).width();
      if(effectiveWidth < 300)
      {
        total_popups = 0;
      }
      else if(effectiveWidth < 1200)
      {
        //320 is width of a single popup box
        total_popups = parseInt(effectiveWidth/300);
      }

      else{
        effectiveWidth = effectiveWidth-250*2;
        total_popups = parseInt(effectiveWidth/300);
      }
      display_popups();

    }

    //recalculate when window is loaded and also when window is resized.
    window.addEventListener("load", calculate_popups);

  

    //minimizes or Maximizes the popup box
    function resizePopup(popupBox,toggle){
        if (popupBox.height() == 283&&toggle==true) {
            $(popupBox).animate(
                    {height: "30px"});
          }
          else if (popupBox.height() == 28) {
            $(popupBox).animate(
                    {height: "285px"});
        }
    }

      //displays the message
    function displayMessage(formElement){
      var message = $(formElement).children('.message-input').val();
        if(message) {
          $(formElement).children('.message-input').val("");
          var decoratedMessage = '<div class="s_message">'+message+'</div>';
          $(formElement).siblings('.popup-messages').append(decoratedMessage);

          var to = $(formElement).parents('.popup-box').attr('id');
          sendMessage(message,to);
        }
    }

    function recieveMessage(data){
      for (var i in popups){
        if (data.from==popups[i]){
          var decoratedMessage = '<div class="r_message">'+data.message+'</div>';
            $('#'+data.from).find('.popup-messages').append(decoratedMessage);
        }
      }
    }

    //message is submitted
    $('body').on('submit', '.message',function(e){
      e.preventDefault();
      displayMessage(this);
    });

    //Any friend from match is clicked
    $('.expert').click(function(){      
      var id=$(this).data('target');
      register_popup(id,id);
    });

    //minimizes or Maximizes the popup box
    $('body').on('click', '.popup-head-left',function(){
        var popupBox = $(this).parents('.popup-box');
        resizePopup(popupBox,true);      
      });

    //closes the popup box
    $('body').on('click', '.popup-head-right',function(){
      var id=$(this).data('target');
      close_popup(id);
    });

    // SOCKET CODE

    var socket = io();

    var user;

    $('.user').click(function(){
      var uname=$(this).data('target');
      setUser(uname);
    });

    function setUser(user){
      this.user=user;
      socket.emit('joinRoom',user);
    }

   /* function setTo(to){
      if (user!=to){
          this.to=to;
         socket.emit('selectChat',user,to);
      }
    } */  

    function sendMessage(message,to){
      var user=this.user;
      if(message){
          socket.emit('msg', { user:user,to:to, message: message});
      }
      return false;
    }

  /*
    socket.on("loadMessages",function(data){
      for (var i in data.messages){
          document.getElementById('message-container').innerHTML += '<div><b>' + data.members[data.messages[i].from] + '</b>: ' + data.messages[i].msg + '</div>'
      }
    });*/

    socket.on('newmsg', function(data){
      recieveMessage(data);
    });

  });
  </script>



    <!-- nodejs script -->
    <script>
        var to;
    </script>
</head>
<body>
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">Sameer Foodie</a>
      <button type="button" class="navbar-toggle btn" data-toggle="collapse" data-target="#myNavbar">
        <i class="glyphicon glyphicon-chevron-down"></i>
      </button>
      <button type="button" class="btn" id="right-panel-button" >
        <i class="glyphicon glyphicon-chevron-left"></i>
      </button>
    </div>
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="nav navbar-nav">
        <li class="active"><a href="#">Recipes</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="#"><span class="glyphicon glyphicon-log-out"></span> Sign Out</a></li>
      </ul>
    </div>
  </div>
</nav>

 <%
  var experts = [
      {
          name:"Sayli Uttarwar",
          id:"sayli"
      },
      {
          name: "Simran Gambani",
          id: "simran"
      },
      {
        name: "Tej Thakkar",
        id: "tej"
      }
  ];
  %>

<div id="wrapper">
 

  <div id="main-content-wrapper">
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-12">

        <br><br><br><br>
          <p>Select User</p>
          <% for (var i in experts){ %>
            <input class="user" type="button" data-target='<%=experts[i].id %>' value='<%=experts[i].id%>'>
          <% } %>
          <p id="message-container"></p>
        
        </div>
      </div>
    </div>
  </div>

  <div class="right-panel">
    <div class="right-panel-header">
      EXPERTS
    </div>

    <% for(var i in experts) {%>
    <div class="expert" data-target='<%= experts[i].id %>'>
        <img width="30" height="30" src="images/1.jpg" />
        <span><%= experts[i].name%></span>
    </div>
     <% }%>

  </div>
</div>
</body>
</html>

